<div class="screen-dim" (click)="onClose()" aria-hidden="true"></div>

<div class="pop-card" aria-modal="true" role="dialog" (click)="$event.stopPropagation()">
  <div class="pop-card__top-actions">
    <button type="button" class="btn-back-home" (click)="onClose()">
      <svg viewBox="0 0 24 24" class="icon-back" aria-hidden="true">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg>
      <span>Volver</span>
    </button>
    <button type="button" class="pop-card__close" aria-label="Cerrar" (click)="onClose()">
      <svg viewBox="0 0 24 24" class="icon-close" aria-hidden="true">
        <path fill="currentColor"
          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z" />
      </svg>
    </button>
  </div>

  <div class="pop-card__media">
    <ng-container *ngIf="content.imagen && content.imagen.trim(); else noimgPop">
      <img [src]="content.imagen!" [alt]="content.titulo" loading="lazy" />
    </ng-container>
    <ng-template #noimgPop>
      <div class="noimg" aria-hidden="true">Sin imagen</div>
    </ng-template>

    <div class="pop-card__badges">
      <span class="badge info">{{ content.tipo }}</span>
      <span *ngIf="content.vip" class="badge vip">VIP</span>
      <span *ngIf="(content.restringidoEdad ?? 0) > 0" class="badge age">+{{ content.restringidoEdad }}</span>
    </div>
  </div>

  <div class="pop-card__body">
    <div class="pop-card__head">
      <h3 class="pop-card__title" [title]="content.titulo">{{ content.titulo }}</h3>
      <div class="pop-card__rating">
        <app-star-rating [contentId]="content.id" [userEmail]="userEmail" [enabled]="false" [autoReproducir]="false">
        </app-star-rating>
      </div>
    </div>

    <div class="screen-dim" (click)="onClose()" aria-hidden="true"></div>

    <div class="pop-card" aria-modal="true" role="dialog" (click)="$event.stopPropagation()">
      <div class="pop-card__top-actions">
        <button type="button" class="btn-back-home" (click)="onClose()">
          <svg viewBox="0 0 24 24" class="icon-back" aria-hidden="true">
            <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
          </svg>
          <span>Volver</span>
        </button>
        <button type="button" class="pop-card__close" aria-label="Cerrar" (click)="onClose()">
          <svg viewBox="0 0 24 24" class="icon-close" aria-hidden="true">
            <path fill="currentColor"
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>

      <div class="pop-card__media">
        <ng-container *ngIf="content.imagen && content.imagen.trim(); else noimgPop">
          <img [src]="content.imagen!" [alt]="content.titulo" loading="lazy" />
        </ng-container>
        <ng-template #noimgPop>
          <div class="noimg" aria-hidden="true">Sin imagen</div>
        </ng-template>

        <div class="pop-card__badges">
          <span class="badge info">{{ content.tipo }}</span>
          <span *ngIf="content.vip" class="badge vip">VIP</span>
          <span *ngIf="(content.restringidoEdad ?? 0) > 0" class="badge age">+{{ content.restringidoEdad }}</span>
        </div>
      </div>

      <div class="pop-card__body">
        <div class="pop-card__head">
          <h3 class="pop-card__title" [title]="content.titulo">{{ content.titulo }}</h3>
          <div class="pop-card__rating">
            <app-star-rating [contentId]="content.id" [userEmail]="userEmail" [enabled]="false"
              [autoReproducir]="false">
            </app-star-rating>
          </div>
        </div>

        <p class="pop-card__desc" *ngIf="content.descripcion">{{ content.descripcion }}</p>

        <div class="pop-card__meta">
          <span>{{ content.resolucion || '—' }}</span>
          <span>·</span>
          <span>{{ content.duracionMinutos || '—' }} min</span>
          <span *ngIf="content.reproducciones !== undefined" class="plays" title="Reproducciones">
            <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"
              style="vertical-align: middle; margin-right: 2px;">
              <path d="M8 5v14l11-7z" />
            </svg>
            {{ content.reproducciones }}
          </span>
        </div>

        <div class="pop-card__actions">
          <button type="button" class="play-btn play-btn--lg" title="Reproducir" (click)="onPlay($event)">
            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
              <path d="M8 5v14l11-7z" />
            </svg>
          </button>

          <button type="button" *ngIf="isUsuario" class="fav-btn fav-btn--lg" [class.is-fav]="isFav"
            [attr.aria-pressed]="isFav" [disabled]="pendingToggle" (click)="onToggleFav($event)"
            [title]="isFav ? '' : ''">
            <svg viewBox="0 0 24 24" class="heart" aria-hidden="true">
              <path
                d="M12 21s-6.3-4.35-9.1-7.13A5.91 5.91 0 0 1 12 4a5.91 5.91 0 0 1 9.1 9.87C18.3 16.65 12 21 12 21z" />
            </svg>
            <span class="sr-only">
              {{ isFav ? '' : '' }}
            </span>
          </button>

          <button *ngIf="!readOnly" type="button" class="rate-btn rate-btn--lg" title="Valorar"
            (click)="onToggleRating($event)">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
            </svg>
          </button>
        </div>

        <div class="lista-add" *ngIf="isUsuario && misListas && misListas.length > 0">
          <div class="lista-add__header">
            <span class="lista-add__label">Añadir a mis listas</span>
            <span class="lista-add__badge">
              <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"
                style="vertical-align: text-bottom; margin-right: 2px;">
                <path
                  d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
              </svg>
              Solo tú
            </span>
          </div>

          <div class="lista-add__controls">
            <select class="lista-add__select" [id]="'lista-select-' + content.id" [(ngModel)]="selectedListaId"
              [disabled]="readOnly || creatingList">
              <option [ngValue]="''">Selecciona una lista…</option>
              <option *ngFor="let l of misListas" [ngValue]="l.id">
                {{ l.nombre }} <span *ngIf="!l.publica"> (privada)</span>
              </option>
            </select>

            <button type="button" class="lista-add__btn" (click)="onAddToList()"
              [disabled]="readOnly || !selectedListaId || creatingList">
              {{ creatingList ? 'Añadiendo…' : 'Añadir' }}
            </button>
          </div>

          <small class="lista-add__msg ok" *ngIf="msgListaOk">
            {{ msgListaOk }}
          </small>
          <small class="lista-add__msg err" *ngIf="msgListaError">
            {{ msgListaError }}
          </small>
        </div>

        <div class="rate-panel" *ngIf="isRatingOpen">
          <app-star-rating [contentId]="content.id" [userEmail]="userEmail" [enabled]="true" [autoReproducir]="false"
            (rated)="onRate($event)">
          </app-star-rating>
          <div class="rate-actions">
            <button type="button" class="btn--ghost" (click)="closeRating()">Cancelar</button>
          </div>
        </div>
      </div>
    </div>