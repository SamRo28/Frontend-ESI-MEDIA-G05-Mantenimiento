<div class="screen-dim" (click)="onClose()" aria-hidden="true"></div>

<div class="pop-card" aria-modal="true" role="dialog" (click)="$event.stopPropagation()">
  <button type="button" class="pop-card__close" aria-label="Cerrar" (click)="onClose()">âœ•</button>

  <div class="pop-card__media">
    <ng-container *ngIf="content.imagen && content.imagen.trim(); else noimgPop">
      <img [src]="content.imagen!" [alt]="content.titulo" loading="lazy" />
    </ng-container>
    <ng-template #noimgPop>
      <div class="noimg" aria-hidden="true">Sin imagen</div>
    </ng-template>

    <div class="pop-card__badges">
      <span class="badge info">{{ content.tipo }}</span>
      <span *ngIf="content.vip" class="badge vip">VIP</span>
      <span *ngIf="(content.restringidoEdad ?? 0) > 0" class="badge age">+{{ content.restringidoEdad }}</span>
    </div>
  </div>

  <div class="pop-card__body">
    <div class="pop-card__head">
      <h3 class="pop-card__title" [title]="content.titulo">{{ content.titulo }}</h3>
      <div class="pop-card__rating">
        <app-star-rating
          [contentId]="content.id"
          [userEmail]="userEmail"
          [enabled]="false"
          [autoReproducir]="false">
        </app-star-rating>
      </div>
    </div>

    <p class="pop-card__desc" *ngIf="content.descripcion">{{ content.descripcion }}</p>

    <div class="pop-card__meta">
      <span>{{ content.resolucion || 'â€”' }}</span>
      <span>Â·</span>
      <span>{{ content.duracionMinutos || 'â€”' }} min</span>
      <span *ngIf="content.reproducciones !== undefined" class="plays" title="Reproducciones">Â· â–¶ {{ content.reproducciones }}</span>
    </div>

    <div class="pop-card__actions">
      <button type="button"
              class="play-btn play-btn--lg"
              title="Reproducir"
              (click)="onPlay($event)">
        â–¶
      </button>

      <button type="button"
              *ngIf="isUsuario"
              class="fav-btn fav-btn--lg"
              [class.is-fav]="isFav"
              [attr.aria-pressed]="isFav"
              [disabled]="pendingToggle"
              (click)="onToggleFav($event)"
              [title]="isFav ? 'Quitar de favoritos' : 'AÃ±adir a favoritos'">
        <svg viewBox="0 0 24 24" class="heart" aria-hidden="true">
          <path d="M12 21s-6.3-4.35-9.1-7.13A5.91 5.91 0 0 1 12 4a5.91 5.91 0 0 1 9.1 9.87C18.3 16.65 12 21 12 21z"/>
        </svg>
        <span class="sr-only">
          {{ isFav ? 'Quitar de favoritos' : 'AÃ±adir a favoritos' }}
        </span>
      </button>

      <button *ngIf="!readOnly"
              type="button"
              class="rate-btn rate-btn--lg"
              title="Valorar"
              (click)="onToggleRating($event)">
        â˜…
      </button>
    </div>

    <div class="lista-add"
        *ngIf="isUsuario && misListas && misListas.length > 0">
      <div class="lista-add__header">
        <span class="lista-add__label">AÃ±adir a mis listas</span>
        <span class="lista-add__badge">ðŸ”’ Solo tÃº</span>
      </div>

      <div class="lista-add__controls">
        <select
          class="lista-add__select"
          [id]="'lista-select-' + content.id"
          [(ngModel)]="selectedListaId"
          [disabled]="readOnly || creatingList">
          <option [ngValue]="''">Selecciona una listaâ€¦</option>
          <option *ngFor="let l of misListas" [ngValue]="l.id">
            {{ l.nombre }} <span *ngIf="!l.publica"> (privada)</span>
          </option>
        </select>

        <button
          type="button"
          class="lista-add__btn"
          (click)="onAddToList()"
          [disabled]="readOnly || !selectedListaId || creatingList">
          {{ creatingList ? 'AÃ±adiendoâ€¦' : 'AÃ±adir' }}
        </button>
      </div>

      <small class="lista-add__msg ok" *ngIf="msgListaOk">
        {{ msgListaOk }}
      </small>
      <small class="lista-add__msg err" *ngIf="msgListaError">
        {{ msgListaError }}
      </small>
    </div>

    <div class="rate-panel" *ngIf="isRatingOpen">
      <app-star-rating
        [contentId]="content.id"
        [userEmail]="userEmail"
        [enabled]="true"
        [autoReproducir]="false"
        (rated)="onRate($event)">
      </app-star-rating>
      <div class="rate-actions">
        <button type="button" class="btn--ghost" (click)="closeRating()">Cancelar</button>
      </div>
    </div>
  </div>
</div>
