<div class="ro-banner" *ngIf="readOnly">
  <span>üìñ Modo lectura activado ‚Äî no puedes interactuar con esta p√°gina.</span>
  <button class="btn-cerrar" *ngIf="fromAdmin" type="button" (click)="salirModoLectura()"
    aria-label="Salir del modo lectura">
    Salir del modo lectura
  </button>
</div>

<div class="ro-wrap" [class.readonly]="readOnly">

  <div class="usuario-shell">

    <header class="user-hero">
      <div class="user-hero-left">
        <div class="user-identity">
          <div class="user-avatar-shell">
            <div class="ava">
              <img *ngIf="userAvatar" [src]="userAvatar" alt="Avatar" class="avatar-img">
              <span *ngIf="!userAvatar" class="avatar-initials">{{ userInitials }}</span>
            </div>
          </div>

          <div class="user-meta">
            <div class="user-meta-main">
              <div class="user-name">{{ userName }}</div>
              <button class="edit-inline" type="button" (click)="toggleEditar()" title="Editar perfil"
                [disabled]="readOnly">
                ‚úèÔ∏è
              </button>
              <span class="user-chip-vip" *ngIf="model?.vip">VIP</span>
            </div>
            <div class="user-email">{{ userEmail }}</div>
          </div>
        </div>

        <p class="hero-subtitle">
          Disfruta de tus contenidos recomendados, favoritos y el historial de lo que has visto.
        </p>
      </div>

      <div class="user-hero-right">
        <div class="catalog-mode" *ngIf="isUsuario">
          <span class="catalog-mode-label">Vista</span>
          <div class="catalog-mode-pills">
            <button type="button" class="catalog-mode-pill" [class.active]="filterMode === 'todos'"
              (click)="filterMode = 'todos'; onFilterChange()">
              üìö Todos
            </button>
            <button type="button" class="catalog-mode-pill" [class.active]="filterMode === 'favoritos'"
              (click)="filterMode = 'favoritos'; onFilterChange()">
              ‚ù§Ô∏è Favoritos
            </button>
            <button type="button" class="catalog-mode-pill" [class.active]="filterMode === 'historial'"
              (click)="filterMode = 'historial'; onFilterChange()">
              üïì Historial
            </button>
          </div>

          <!-- Select real para accesibilidad / teclado -->
          <label for="catalogFilter" class="sr-only">Filtro de cat√°logo</label>
          <select id="catalogFilter" class="catalog-mode-select sr-only" [(ngModel)]="filterMode"
            (change)="onFilterChange()">
            <option value="todos">üìö Todos</option>
            <option value="favoritos">‚ù§Ô∏è Mis favoritos</option>
            <option value="historial">üïì Historial</option>
          </select>
        </div>

        <button class="btn-cerrar hero-logout" (click)="CerrarSesion()">Cerrar sesi√≥n</button>
      </div>
    </header>

    <section class="contenidos-section" aria-label="Cat√°logo de contenidos">

      <div class="user-layout">

        <aside class="user-filters">
          <button type="button" class="btn--ghost mobile-filter-toggle" (click)="toggleFilters()">
            {{ showFilters ? 'Ocultar filtros' : 'Mostrar filtros' }} üîΩ
          </button>
          <div class="user-filters-card" [class.filters-open]="showFilters">
            <div class="user-filters-header">
              <h3 class="user-filters-title">üîé Filtros</h3>
              <span class="user-filters-badge">
                {{ filteredCon.length || 0 }} resultado(s)
              </span>
            </div>

            <form (submit)="$event.preventDefault()">
              <div class="filter-section">
                <label for="q">üî§ B√∫squeda (T√≠tulo)</label>
                <input id="q" type="text" name="q" [(ngModel)]="filtrosContenido.q" (ngModelChange)="onFiltrosChange()"
                  placeholder="Buscar..." />
              </div>

              <div class="filter-section">
                <label for="tipo">üéûÔ∏è Tipo</label>
                <select id="tipo" name="tipo" [(ngModel)]="filtrosContenido.tipo" (ngModelChange)="onFiltrosChange()">
                  <option value="">Todos</option>
                  <option *ngFor="let t of tiposDisponibles" [value]="t">{{ t }}</option>
                </select>
              </div>

              <div class="filter-section">
                <label for="categoria">üè∑Ô∏è Categor√≠a</label>
                <select id="categoria" name="categoria" [(ngModel)]="filtrosContenido.categoria"
                  (ngModelChange)="onFiltrosChange()">
                  <option value="">Todas</option>
                  <option *ngFor="let c of categoriasDisponibles" [value]="c">{{ c }}</option>
                </select>
              </div>

              <div class="filter-section" *ngIf="canSeeVip()">
                <label for="role">üõ°Ô∏è Rol de acceso</label>
                <select id="role" name="role" [(ngModel)]="filtrosContenido.role" (ngModelChange)="onFiltrosChange()">
                  <option value="">Cualquiera</option>
                  <option value="VIP">VIP</option>
                  <option value="STANDARD">Est√°ndar</option>
                </select>
              </div>

              <div class="filter-section">
                <label>üë∂ Clasificaci√≥n por edad</label>
                <div class="age-row">
                  <select name="ageMode" [(ngModel)]="filtrosContenido.ageMode" (ngModelChange)="onFiltrosChange()">
                    <option value="">Sin filtro</option>
                    <option value="mayores">Mayores de‚Ä¶ (+X)</option>
                    <option value="menores">Menores de‚Ä¶ (‚â§X)</option>
                  </select>
                  <input type="number" min="0" name="ageValue" [(ngModel)]="filtrosContenido.ageValue"
                    (ngModelChange)="onFiltrosChange()" placeholder="X" />
                </div>
              </div>

              <div class="filter-section">
                <label for="resol">üñ•Ô∏è Resoluci√≥n</label>
                <select id="resol" name="resolucion" [(ngModel)]="filtrosContenido.resolucion"
                  (ngModelChange)="onFiltrosChange()">
                  <option value="">Todas</option>
                  <option *ngFor="let r of resolucionesDisponibles" [value]="r">{{ r }}</option>
                </select>
              </div>

              <div class="filter-section">
                <label for="listaPublica">üìÇ Lista</label>
                <select id="listaPublica" name="listaPublica" [(ngModel)]="filtrosContenido.listaId"
                  (ngModelChange)="onFiltrosChange()">
                  <option value="">Todas</option>
                  <option *ngFor="let l of listasPublicas" [value]="l.id">
                    {{ l.nombre }} <span *ngIf="!l.publica"> (privada)</span>
                  </option>
                </select>
                <small class="hint" *ngIf="!listasPublicas || listasPublicas.length === 0">
                  No tienes listas ni hay listas p√∫blicas disponibles.
                </small>
              </div>

              <div class="filter-section">
                <label for="orden">‚ÜïÔ∏è Ordenar</label>
                <select id="orden" name="ordenar" [(ngModel)]="filtrosContenido.ordenar"
                  (ngModelChange)="onFiltrosChange()">
                  <option value="fecha">Fecha</option>
                  <option value="titulo">T√≠tulo</option>
                  <option value="reproducciones">Reproducciones</option>
                </select>
              </div>

              <div class="filter-section">
                <label for="dir">‚¨Ü‚¨á Direcci√≥n</label>
                <select id="dir" name="dir" [(ngModel)]="filtrosContenido.dir" (ngModelChange)="onFiltrosChange()">
                  <option value="desc">Descendente</option>
                  <option value="asc">Ascendente</option>
                </select>
              </div>

              <button type="button" class="btn--ghost btn-reset" (click)="resetFiltros()">Limpiar filtros</button>
            </form>
          </div>
        </aside>

        <!-- √ÅREA DE CAT√ÅLOGO -->
        <main class="content-area user-catalog">

          <div *ngIf="contenidosLoading" class="state loading">
            <div class="spinner"></div>
            <span>Cargando contenidos‚Ä¶</span>
          </div>

          <div *ngIf="!contenidosLoading && contenidosError" class="state error">
            <span>‚ö† {{ contenidosError }}</span>
            <button class="btn--ghost" type="button" (click)="cargarContenidos()">Reintentar</button>
          </div>

          <div *ngIf="!contenidosLoading && !contenidosError && filteredCon.length === 0" class="state empty">
            <span>No hay contenidos disponibles.</span>
          </div>

          <div class="catalog-wrap" *ngIf="!contenidosLoading && !contenidosError && filteredCon.length > 0">
            <div class="catalog-frame" #frame>
              <div class="catalog-frame__head">
                <div class="catalog-frame__head-left">
                  <div class="catalog-frame__title-row">
                    <h2 class="catalog-frame__title">Cat√°logo</h2>

                    <button type="button" *ngIf="isUsuario" class="catalog-addlist-btn" (click)="openCrearListaModal()"
                      [disabled]="readOnly">
                      <span class="icon">‚ûï</span>
                      <span>Lista privada</span>
                    </button>
                  </div>

                  <p class="catalog-frame__subtitle">
                    {{ filteredCon.length }} contenido(s) ¬∑ p√°gina {{ page }} / {{ totalPages }}
                  </p>
                </div>

                <div class="catalog-chip-view" *ngIf="isUsuario">
                  <span *ngIf="filterMode === 'todos'">üìö Todos</span>
                  <span *ngIf="filterMode === 'favoritos'">‚ù§Ô∏è Tus favoritos</span>
                  <span *ngIf="filterMode === 'historial'">üïì Historial visto</span>
                </div>
              </div>


              <div class="grid">
                <article *ngFor="let c of pagedCon" class="card" [class.is-open]="isDetailsOpen(c)">
                  <div class="thumb" [class.launching]="launchingId===c.id" (click)="openDetails(c)"
                    (keydown)="handleKeyDown($event)">
                    <ng-container *ngIf="c.imagen && c.imagen.trim(); else noimg">
                      <img [src]="c.imagen!" [alt]="c.titulo" loading="lazy" />
                    </ng-container>
                    <ng-template #noimg>
                      <div class="noimg" aria-hidden="true">Sin imagen</div>
                    </ng-template>

                    <div class="badges">
                      <span class="badge info">{{ c.tipo }}</span>
                      <span *ngIf="c.vip" class="badge vip">VIP</span>
                      <span *ngIf="(c.restringidoEdad ?? 0) > 0" class="badge age">+{{ c.restringidoEdad }}</span>
                    </div>

                    <div class="title-bar">
                      <h3 class="card-title" [title]="c.titulo">{{ c.titulo }}</h3>
                      <app-star-rating class="rating-only" [contentId]="c.id" [userEmail]="userEmail" [enabled]="false"
                        [autoReproducir]="false">
                      </app-star-rating>
                    </div>

                    <div class="thumb-actions">
                      <button type="button" class="play-btn" title="Reproducir"
                        (click)="play(c); $event.stopPropagation()">‚ñ∂</button>
                      <button *ngIf="!readOnly" type="button" class="rate-btn" title="Valorar"
                        (click)="toggleRating(c); $event.stopPropagation()">‚òÖ</button>
                    </div>
                  </div>

                  <app-content-details-modal *ngIf="isDetailsOpen(c)" [content]="c" [userEmail]="userEmail"
                    [isUsuario]="isUsuario" [readOnly]="readOnly" [misListas]="misListas" [isFav]="isFav(c.id)"
                    [pendingToggle]="pendingToggle[c.id]" [creatingList]="creandoListaContenido[c.id]"
                    [msgListaOk]="msgListaOk[c.id]" [msgListaError]="msgListaError[c.id]" (close)="closeDetails(c)"
                    (play)="play(c)" (toggleFav)="onToggleFav(c.id)" (toggleRating)="toggleRating(c)"
                    (rate)="onRated(c.id, $event)" (addToList)="anadirContenidoALista(c, $event)">
                  </app-content-details-modal>

                </article>
              </div>

              <div class="pager">
                <button (click)="prevPage()" [disabled]="page <= 1">¬´</button>
                <span class="page-info">P√°gina {{ page }} / {{ totalPages }}</span>
                <button (click)="nextPage()" [disabled]="page >= totalPages">¬ª</button>
              </div>

            </div>
          </div>

        </main>

      </div>
    </section>

  </div>

  <app-edit-profile-modal *ngIf="editOpen" [userEmail]="userEmail" [model]="model" [readOnly]="readOnly"
    [aliasError]="aliasError" [aliasChecking]="aliasChecking" [aliasTaken]="aliasTaken" [saving]="saving"
    [okMsg]="okMsg" [errorMsg]="errorMsg" [selectedAvatar]="selectedAvatar" (close)="cancelarEditar()"
    (save)="guardarCambios()" (darDeBaja)="DarDeBaja()" (openAvatarModal)="openAvatarModal()"
    (aliasChange)="onAliasChange($event)" (vipChange)="onVipChanged($event)">
  </app-edit-profile-modal>

  <app-avatar-selector-modal *ngIf="showAvatarModal" [avatars]="avatars" [selectedAvatar]="selectedAvatar"
    (close)="closeAvatarModal()" (select)="selectAvatar($event)">
  </app-avatar-selector-modal>

  <app-media-player-modal *ngIf="playerOpen" [playingTitle]="playingTitle" [playerKind]="playerKind"
    [playerSrc]="playerSrc" [embedUrl]="embedUrl" (close)="closePlayer()">
  </app-media-player-modal>
  <app-create-list-modal *ngIf="showCrearListaModal" [nombre]="nuevaListaNombre" [descripcion]="nuevaListaDescripcion"
    [creating]="creatingList" [okMsg]="crearListaOk" [errorMsg]="crearListaError" (close)="closeCrearListaModal()"
    (create)="crearLista()" (nombreChange)="nuevaListaNombre = $event"
    (descripcionChange)="nuevaListaDescripcion = $event">
  </app-create-list-modal>



</div>